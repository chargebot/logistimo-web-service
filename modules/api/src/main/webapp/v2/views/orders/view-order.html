<!--
  ~ Copyright Â© 2017 Logistimo.
  ~
  ~ This file is part of Logistimo.
  ~
  ~ Logistimo software is a mobile & web platform for supply chain management and remote temperature monitoring in
  ~ low-resource settings, made available under the terms of the GNU Affero General Public License (AGPL).
  ~
  ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General
  ~ Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any
  ~ later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied
  ~ warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License along with this program.  If not, see
  ~ <http://www.gnu.org/licenses/>.
  ~
  ~ You can be released from the requirements of the license by purchasing a commercial license. To know more about
  ~ the commercial license, please contact us at opensource@logistimo.com
  -->

<div ng-controller="OrderDetailCtrl">
<div class="panel panel-default">
    <div ng-show="!errMsg" class="panel-heading">
        <b>{{resourceBundle['order']}} {{orderId}}</b>

        <div class="pull-right">
            <a href="/s/orders/invoice.jsp?oid={{orderId}}" target="_new" uib-tooltip="{{resourceBundle['invoice']}}" tooltip-append-to-body="true"><span
                    class="glyphicons glyphicons-print tglyph"></span></a>
            <a href="" onclick="javascript:window.open('/s/help/help.jsp?type=purchaseorder','purchaseorder','location=0,resizable=1,scrollbars=1,width=800,height=350');" uib-tooltip="{{resourceBundle['help']}}" tooltip-append-to-body="true"><span
                class="glyphicons glyphicons-info-sign tglyph"></span></a>
        </div>
    </div>
    <div class="panel-body" ng-show="loading && !errMsg">
        <span class="glyphicons glyphicons-cogwheel spin"></span>
    </div>
    <div class="panel-body alert alert-warning alert-warning-dark" ng-show="errMsg">
        <span>{{errMsg}}</span>
    </div>
    <div class="panel-body" ng-show="!loading && !errMsg">
        <div ng-show="order.pst != null ">
            <div class="row">
                <div ng-hide="oCfg.dop" class="col-sm-12"><b>{{order.pst}} </b>
                <span class="pull-right" ng-hide="order.lt == undefined || order.ln == undefined || (order.lt == 0 && order.ln == 0)"><a ng-click="toggleMap()"><span class="glyphicons glyphicons-globe" uib-tooltip="{{resourceBundle['map.view']}}"></span></a></span></div>
            </div>
            <div class="row" ng-show="aCfg.ea && order.pd < order.tp && order.tp > order.avc && !oCfg.dop">
                <div class="col-sm-12"><span class="fc-color-red">{{resourceBundle['order.exceedslimit']}}
                    {{order.cur}} {{order.avc}}</span>
                </div>
            </div>
        </div>
        <div class="bgr" ng-if="dispMap">
            <div class="row">
                <div class="col-sm-12">
                    <div ng-init=" type = 'c'; dName = order.enm; lt = order.lt; ln = order.ln; lklt = order.elt; lkln = order.eln; mtype = 'o'; accuracy = order.ac;"
                         ng-include="'views/transactions/view-map.html'"></div>
                </div>
            </div>
        </div>
        <div class="bgr">
            <div class="row">
                <div class="col-sm-12">
                    <table class="table table-striped table-codensed">
                        <tbody>
                        <tr>
                            <td class="col-sm-2"><label class="control-label">{{resourceBundle['status']}}</label></td>
                            <td>
                                <span ng-hide="edit.st">{{ORDER.statusTxt[order.st]}}<a ng-click="editStatus()" class="ml15">
                                    <span ng-hide="dp.vp" class="glyphicons glyphicons-edit" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true"></span>
                                </a></span>
                                <div class="bgr whitebg" ng-hide="!edit.st">
                                <form class="form-horizontal" role="form" name="addEntityForm"
                                      >
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label required">{{resourceBundle['order.new.status']}}</label>

                                        <div class="col-sm-4">
                                            <select ng-model="newStatus.st" class="form-control">
                                                <option value="">-- {{resourceBundle['select']}} {{resourceBundle['status']}} --</option>
                                                <option ng-repeat="status in statusList" value="{{status}}">
                                                    {{ORDER.statusTxt[status]}}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">{{resourceBundle['message']}}</label>

                                        <div class="col-sm-9">
                                            <textarea ng-model="newStatus.msg" class="form-control"></textarea>
                                        </div>
                                    </div>
                                    <p>{{resourceBundle['message.sendviasms']}}</p>
                                    <hr/>
                                    <span class="pull-right"><button class="btn btn-sm btn-default" ng-click="resetMsgUsers()">{{resourceBundle['reset']}}</button></span>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">{{resourceBundle['kiosk']}} {{resourceBundle['users']}}</label>

                                        <div class="col-sm-6">
                                            <div class="scrollbox ">
                                                <table class="table table-striped table-condensed table-bordered table-min">
                                                    <tr ng-repeat="user in entityUsers">
                                                        <td>
                                                            <input type="checkbox" checklist-model="newStatus.users" checklist-value="user.id"/>
                                                            {{user.fnm}} {{user.lnm}}[{{user.phm}}]
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">{{resourceBundle['vendors']}}</label>

                                        <div class="col-sm-6">
                                            <div class="scrollbox ">
                                                <table class="table table-striped table-condensed table-bordered table-min">
                                                    <tr ng-repeat="user in vendorUsers">
                                                        <td>
                                                            <input type="checkbox" checklist-model="newStatus.users" checklist-value="user.id"/>
                                                            {{user.fnm}} {{user.lnm}} [{{user.phm}}]
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div ng-show="admins" class="form-group">
                                        <label class="col-sm-2 control-label">{{resourceBundle['administrators']}}</label>

                                        <div class="col-sm-6">
                                            <div class="scrollbox ">
                                                <table class="table table-striped table-condensed table-bordered table-min">
                                                    <tr ng-repeat="user in administrators">
                                                        <td>
                                                            <input type="checkbox" checklist-model="newStatus.users" checklist-value="user.id"/>
                                                            {{user.fnm}} {{user.lnm}} [{{user.phm}}]
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="pull-right">
                                                <button class="btn btn-sm btn-primary"
                                                        ng-click="saveStatus()">
                                                    {{resourceBundle['save']}}
                                                </button>
                                                <button class="btn btn-sm btn-default"
                                                        ng-click="cancelStatusEdit()">
                                                    {{resourceBundle['cancel']}}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['placedby']}}</label></td>
                            <td><a ng-href="#/setup/users/all/details?userId={{order.uid}}" target="_blank">{{order.unm}}</a></td>
                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['customer']}}</label></td>
                            <td ng-show="order.enm != ''"><a ng-href="#/setup/entities/detail/{{order.eid}}" target="_blank">{{order.enm}}</a>, {{order.eadd}}</td>
                            <td ng-show="order.enm == ''">{{resourceBundle['none']}}</td>
                        </tr>
                        <tr>
                            <td><label class="control-label required">{{resourceBundle['vendor']}}</label></td>
                            <td>
                                <form class="form-inline" role="form" name="vnForm">
                                    <span ng-hide="edit.vend">
                                        <span ng-show="isDef(order.vid)"><a
                                                href="#/setup/entities/detail/{{order.vid}}" target="_blank">{{order.vnm}}</a><span ng-show="order.vadd">, {{order.vadd}}</span>
                                        </span>
                                        <span ng-hide="isDef(order.vid)" class="fc-color-red">
                                            {{resourceBundle['order.specifyvendor']}}
                                        </span>
                                        <span ng-show="isDef(order.vid) && order.vid == -1" class="fc-color-red">
                                            {{resourceBundle['order.novendor']}}
                                        </span>
                                        <a class="ml15"
                                           ng-show="(order.st == ORDER.PENDING || order.st == ORDER.CONFIRMED)"
                                           ng-click="toggleEdit('vend')" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true">
                                            <span ng-hide="dp.vp" class="glyphicons glyphicons-edit"></span>
                                        </a>
                                    </span>

                                    <span ng-hide="!edit.vend">
                                        <entity-select ent-model="vendor" on-select="setVendor()"
                                                       place-holder="Choose {{resourceBundle['vendor.lowercase']}}" ent-type="vendors"
                                                       ent-id="order.eid" classes="form-control" style="display:inline-block"></entity-select>
                                        <button class="btn btn-sm btn-primary" ng-click="saveVendor('vend')">
                                            {{resourceBundle['save']}}
                                        </button>
                                        <button class="btn btn-sm btn-default" ng-click="toggleEdit('vend')">
                                            {{resourceBundle['cancel']}}
                                        </button>
                                    </span>
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['createdon']}}</label></td>
                            <td>{{order.cdt}} <span class="litetext" ng-show="isDef(order.udt)">[{{resourceBundle['lastupdated']}} {{order.udt}} <span ng-show="isDef(order.uby)">{{resourceBundle['by']}} <a ng-href="#/setup/users/all/details?userId={{order.ubid}}" target="_blank">{{order.uby}}</a></span>]</span></td>
                        </tr>
                        <tr>
                            <td><label class="control-label">Expected delivery date</label> </td>
                            <td>
                                <form class="form-inline" role="form" name="updTransForm">
                                    <span ng-hide="edit.edd">{{edd}}
                                        <span ng-show="isUndef(order.edd)" class="dinline cbx">{{resourceBundle['none']}}</span>
                                        <a uib-tooltip="Edit" class="ml15 cbx" ng-click="editEDD()" tooltip-append-to-body="true">
                                            <span ng-hide="dp.vp" class="ml15 glyphicons glyphicons-edit cbx"></span>
                                        </a>
                                    </span>
                                    <span ng-hide="!edit.edd">
                                        <date-picker min-date="today" date-model="order.edd"></date-picker>
                                        <a ng-click="saveEDD()">
                                            <button class="btn btn-sm btn-primary">{{resourceBundle['save']}}</button>
                                        </a>
                                        <a ng-click="toggleEdit('edd')">
                                            <button class="btn btn-sm btn-default">{{resourceBundle['cancel']}}</button>
                                        </a>
                                    </span>
                                </form>
                            </td>

                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['referenceid']}}</label></td>
                            <td>
                                <form class="form-inline" role="form" name="updTransForm">
                                    <span ng-hide="edit.rid">{{order.rid}}
                                        <span ng-show="isUndef(order.rid)">{{resourceBundle['none']}}</span>
                                        <a uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true" class="ml15" ng-click="editRID()">
                                        <span ng-hide="dp.vp" class="m15 glyphicons glyphicons-edit"></span>
                                        </a>
                                    </span>
                                 <span ng-hide="!edit.rid">
                                    <input type="text" ng-model="referenceID" class="form-control" maxlength="50" />
                                        <a ng-click="saveRID()">
                                            <button class="btn btn-sm btn-primary"> {{resourceBundle['save']}}
                                            </button>
                                        </a>
                                        <a ng-click="toggleEdit('rid')">
                                            <button class="btn btn-sm btn-default"> {{resourceBundle['cancel']}}
                                            </button>
                                        </a>
                                </span>
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['order']}} {{resourceBundle['tags']}}</label></td>
                            <td>
                                <form class="form-group mb0" role="form" name="updTransForm">
                                <span ng-hide="edit.otags">
                                    <div ng-logi-tags tgs="order.tgs"></div>
                                    <span ng-show ="isUndef(order.tgs)" class="dinline cbx">{{resourceBundle['none']}}</span>
                                    <a uib-tooltip="Edit" ng-click="editTags()" tooltip-append-to-body="true">
                                        <span ng-hide="dp.vp" class="ml15 glyphicons glyphicons-edit cbx"></span>
                                    </a>
                                </span>
                                <span ng-hide="!edit.otags">
                                    <div class="col-sm-5 noleftpad">
                                        <tag-select tags-model="oTags" type="'order'"
                                                    multiple="'true'"></tag-select>
                                    </div>
                                    <button class="btn btn-sm btn-primary" ng-click="saveTags(oTags)">
                                        {{resourceBundle['save']}}
                                    </button>
                                    <button class="btn btn-sm btn-primary" ng-click="toggleEdit('otags')">
                                        {{resourceBundle['cancel']}}
                                    </button>
                                </span>
                                </form>
                            </td>
                        </tr>
                        <tr ng-show="order.msg != ''">
                            <td><label class="control-label">{{resourceBundle['message']}}</label></td>
                            <td><div class="table-scroll"><table class="table table-condensed table-nobot-mar">
                                <tbody>
                                    <tr ng-repeat="msg in order.msg.split(';') track by $index" ><td width="100%" colspan="100%">{{msg}}</td></tr>
                                </tbody>
                            </table></div></td>
                        </tr>
                            <tr ng-show="order.cft != null || order.eft != null">
                            <td><label class="control-label">{{resourceBundle.expectedfulfillmenttime}}</label></td>
                            <td>
                                <span ng-hide="edit.cft">{{order.cft}}</span>
                                <a ng-hide="order.eft == null || edit.cft" class="ml15" ng-click="toggleEdit('cft')" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true">
                                    <span ng-hide="dp.vp" class="glyphicons glyphicons-edit"></span>
                                </a>
                                <form class="form-inline" role="form" name="editConfirmation" ng-show="edit.cft">
                                    {{resourceBundle.expectedfulfillmenttimeselectmsg}}<br/>
                                    <select class="form-control" ng-model="newCft">
                                        <option value="">{{resourceBundle.none}}</option>
                                        <option ng-repeat="(key,val) in order.eft" value="{{key}}">{{val}}</option>
                                    </select>
                                    <button class="btn btn-sm btn-primary" ng-click="saveFulfillmentTime('cft')">{{resourceBundle['save']}}
                                    </button>
                                    <button class="btn btn-sm btn-default" ng-click="toggleEdit('cft')">{{resourceBundle['cancel']}}
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <tr ng-show="aCfg.ea && !oCfg.dop">
                            <td><label class="control-label">{{resourceBundle['payment']}}</label></td>
                            <td>
                                <form class="form-inline" role="form" name="addPayment">
                                    <span ng-hide="edit.pmt">
                                        <span ng-show="order.pd != 0">{{order.cur}} {{order.pd | number : 2}} [{{order.po}}] </span>
                                        <span
                                            ng-show="order.pd >= order.tp"
                                            class="greentxt">[{{resourceBundle['paid']}}]
                                        </span>
                                        <span
                                            ng-show="order.pd < order.tp">[ {{resourceBundle['balance']}}: <span class="fc-color-red">{{order.cur}} {{(order.tp - order.pd) | number : 2}}</span> , {{resourceBundle['availablecredit']}}: {{order.cur}} {{order.avc| number : 2}} ]</span>
                                        <a class="ml15" ng-click="editPayment('pmt')" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true">
                                            <span ng-hide="dp.vp" class="glyphicons glyphicons-edit"></span>
                                        </a>
                                    </span>
                                    <span ng-hide="!edit.pmt">
                                        <input ng-hide="payOpts.length > 0" type="text" ng-model="pmt.po"
                                               class="form-control"
                                               placeholder="Payment Option"/>
                                    <select ng-hide="payOpts.length == 0" class="form-control" ng-model="pmt.po">
                                        <option ng-repeat="po in payOpts">{{po}}</option>
                                    </select>

                                    {{order.cur}}<input type="text" ng-model="pmt.pay" class="form-control"
                                           placeholder="Enter Amount"/>
                                    <button class="btn btn-sm btn-primary" ng-click="savePayment('pmt')">{{resourceBundle['save']}}
                                    </button>
                                    <button class="btn btn-sm btn-default" ng-click="toggleEdit('pmt')">{{resourceBundle['cancel']}}
                                    </button>
                                    <span class="litetext">{{resourceBundle['payment.paidsofar']}}: {{order.cur}} {{order.pd}}</span>
                                    </span>
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td><label class="control-label">{{resourceBundle['packagesize']}}</label></td>
                            <td>
                                <form class="form-inline" role="form" name="pkgForm">
                                    <span ng-hide="edit.pkgs">{{order.pkgs}}
                                        <span ng-show="isUndef(order.pkgs)">{{resourceBundle['none']}}</span>
                                        <a class="ml15"
                                                                                ng-click="editPackage()" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true">

                                        <span ng-hide="dp.vp" class="glyphicons glyphicons-edit"></span>
                                    </a></span>

                                    <div ng-hide="!edit.pkgs">
                                        <input ng-hide="packSizes.length > 0" type="text" ng-model="pkgs"
                                               class="form-control"/>
                                        <select ng-hide="packSizes.length == 0" class="form-control"
                                                ng-model="pkgs">
                                            <option value="">-- {{resourceBundle['select']}} --</option>
                                            <option ng-repeat="pkg in packSizes" value="{{pkg}}">{{pkg}}
                                            </option>
                                        </select>

                                        <button class="btn btn-sm btn-primary" ng-click="savePackage()">
                                            {{resourceBundle['save']}}
                                        </button>
                                        <button class="btn btn-sm btn-default" ng-click="toggleEdit('pkgs')">
                                            {{resourceBundle['cancel']}}
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td><label class="control-label" ng-class="{required:oCfg.tm}">{{resourceBundle['transporter']}}</label></td>
                            <td>
                                <form class="form-inline" role="form" name="updTransForm">
                                    <span ng-hide="edit.trns">{{order.trns}} <span ng-show="isUndef(order.trns)">{{resourceBundle['none']}}</span><a class="ml15"
                                                                                ng-click="editTransporter('trns')">

                                        <span ng-hide="dp.vp" class="glyphicons glyphicons-edit" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true"></span>
                                    </a></span>
                                    <span ng-hide="!edit.trns">
                                            <input type="text" ng-hide="!edit.trns" ng-model="transporter"
                                                   class="form-control"
                                                   />
                                            <a ng-click="saveTransporter('trns')">
                                                <button class="btn btn-sm btn-primary"> {{resourceBundle['save']}}
                                                </button>
                                            </a>
                                            <a ng-click="toggleEdit('trns')">
                                                <button class="btn btn-sm btn-default"> {{resourceBundle['cancel']}}
                                                </button>
                                            </a>
                                        </span>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="greentxt">{{resourceBundle['order.processingtime']}}: {{order.pt}}, {{resourceBundle['order.deliveryleadtime']}}: {{order.dlt}}
                    </div>
                </div>
            </div>
        </div>
        <div class="bgr">
            <div class="row">
                <div class="col-sm-12">
                    <b>{{order.size}}</b> {{resourceBundle['order.items']}}
                    <span class="pull-right">
                        <input type="checkbox" ng-model="showCurStk"><span class="pr30"> {{resourceBundle['show.current.stock']}}</span>
                        <a ng-hide="edit.mat || !(order.st == 'pn' || order.st == 'cf') || dp.vp" ng-click="startEditMats()" uib-tooltip="{{resourceBundle['edit']}}" tooltip-append-to-body="true"><span
                            class="glyphicons glyphicons-edit" ></span></a>
                        <span ng-show="edit.mat">
                                <button class="btn btn-sm btn-primary"
                                        ng-click="saveMaterials()" ng-disabled="invalidPopup != 0 || saveDisable">
                                    {{resourceBundle['save']}}
                                </button>
                                <button class="btn btn-sm btn-default"
                                        ng-click="cancelEditMats()">
                                    {{resourceBundle['cancel']}}
                                </button>
                        </span>
                    </span>
                </div>
            </div>
            <div class="row" ng-show="edit.mat || isDef(order.its)">
                <div class="col-sm-12">
                    <table class="table table-striped table-condensed">
                        <tbody>
                        <tr>
                            <th class="col-sm-2">{{resourceBundle['material']}}</th>
                            <th class="col-sm-2 text-center">{{resourceBundle['quantity']}}</th>
                            <th class="col-sm-0-1"></th>
                            <th class="text-center" ng-show="showCurStk">{{resourceBundle['customer.stock']}}</th>
                            <th ng-hide="oCfg.dop" class="col-sm-1 text-center">{{resourceBundle['price']}} <span ng-show="isDef(order.cur)">({{order.cur}})</span></th>
                            <th ng-show="edit.mat && !oCfg.dop" class="col-sm-1 text-center"></th>
                            <th ng-hide="oCfg.dop"  class="text-right">{{resourceBundle['amount']}} <span ng-show="isDef(order.cur)">({{order.cur}})</span></th>
                            <th ng-show="oCfg.agi" class="text-center">{{resourceBundle['vendor.stock']}}</th>
                            <th ng-if="edit.mat"></th>
                        </tr>
                        <tbody ng-repeat="item in order.its" ng-controller="DemandItemController" data-ng-switch on="exRow[$index]">
                        <tr>
                            <td>{{item.nm}}</td>
                            <td class="text-center">
                                <div ng-hide="edit.mat">
                                    {{item.q}}
                                    <span ng-show="item.oq != item.q" class="fc-color-orange litetext">{{resourceBundle['ordered']}}: {{item.oq}}</span>
                                </div>
                                <div ng-show="edit.mat">
                                    <input ng-if="!item.isBn" class="form-control" type="text" only-digits ng-model="item.q"
                                           id="{{item.id}}{{$index}}"
                                           ng-class="{'red-border':item.invalidPopup}"
                                           uib-popover="{{item.popupMsg}}" popover-trigger="showpopup"
                                           ng-focus="saveBatchQ($index);hidePop(item,$index)"
                                           ng-blur="validateBatchQ($index);validate(item,$index,'b')" maxlength="12">
                                    <select class="form-control" ng-if="item.isBn" ng-model="item.q">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                    </select>
                                </div>
                                <span ng-show="item.q != item.rq && item.rq !='-1'" class="litetext"><span class="fc-color-red">{{resourceBundle['order.recommended']}}: {{item.rq | number : 0}}</span><br/>
                                    <span ng-show="item.rsn!= null && (!edit.mat || item.q == item.qq)" class="text-center">({{item.rsn}})</span>
                                </span>
                                <div ng-show="edit.mat && item.q!= item.qq && item.q != item.rq && item.rq !='-1'">
                                    <select class="form-control col-sm-3" ng-model="item.nrsn" ng-change="item.mrsn = ''" ng-show="isDef(reasons)">
                                        <option ng-repeat="val in reasons" value="{{val}}"> {{val||resourceBundle['select'] + ' ' + resourceBundle['reason.lowercase']}} </option>
                                    </select>
                                    <textarea type="text" ng-show="item.nrsn.toLowerCase() == 'others' || isUndef(reasons)" class="form-control col-sm-2"
                                           ng-model="item.mrsn" placeholder="{{resourceBundle['enterreason']}}" maxlength="160" style="margin-top: 4px" />
                                </div>
                            </td>
                            <td>
                                <div ng-show="item.q > 0">
                                    <div ng-switch on="item.isBa">
                                        <div ng-switch-when="true">
                                            <table class="table table-striped table-condensed"
                                                   ng-show="item.bts">
                                                <tbody>
                                                <tr>
                                                    <td>{{resourceBundle['batch']}}</td>
                                                    <td>{{resourceBundle['expiry']}}</td>
                                                    <td>{{resourceBundle['quantity']}}</td>
                                                </tr>
                                                <tr ng-repeat="bitem in item.bts">
                                                    <td>{{bitem.id}}</td>
                                                    <td>{{bitem.e}}</td>
                                                    <td class="text-center">{{bitem.q}}</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            <div ng-show="edit.mat" class="text-center">
                                                <div ng-init="mid=item.id;kid=order.vid"></div>
                                                <div ng-show="item.isBa && order.hva" ng-controller="BatchTransactionCtrl">
                                                    <a ng-click="select($index,'show')" class="btn btn-sm btn-default">{{resourceBundle['allocate.batch']}}</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td ng-show="showCurStk" class="text-center" ng-class=" {'alert-danger' : item.event == 200,
                                         'alert-info alert-info-dark' : item.event == 202,
                                         'alert-warning alert-warning-dark' : item.event == 201} ">
                                {{item.stk}}
                            </td>
                            <td ng-hide="oCfg.dop" class="text-center">{{item.p}}<span class="litetext" ng-hide="item.tx <= 0">{{resourceBundle['tax']}}: {{item.tx}}%</span><span class="litetext" ng-hide="item.d <= 0">{{resourceBundle['discount']}}: {{item.d}}%</span></td>
                            <td ng-show="edit.mat && !oCfg.dop">
                                <a ng-click="toggleDiscount($index)" ng-hide="edit.ds[$index]">{{resourceBundle['discount']}}</a>
                                <span ng-show="edit.ds[$index]"><input  type="text" class="form-control input-sm col-sm-8 w80"
                                           ng-model="item.d" only-digits allow-decimal maxlength="6"><div class="cbx">%</div></span>
                            </td>

                            <td ng-hide="oCfg.dop" class="text-right"><span ng-hide="edit.mat">{{item.a}}</span><span ng-hide="!edit.mat">{{(item.q*item.p)*(100-item.d)/100 || 0  | number : 2}}</span>
                            </td>
                            <td ng-show="oCfg.agi" class="text-center bg-info"><span ng-class="{'fc-color-red': item.vs < item.q}">{{item.vs}}</span></td>
                            <td ng-if="edit.mat" class="text-center"><a ng-show="item.added" ng-click="removeRow($index)" uib-tooltip="{{resourceBundle['remove']}}" tooltip-append-to-body="true"><span
                                    class="glyphicons glyphicons-bin"></span></a></td>
                        </tr>
                        <tr data-ng-switch-when="show">
                            <td colspan=100% class="partialview">
                                <div ng-init="view='views/transactions/batch-transaction.html';huName = item.huName; huQty = item.huQty; mnm = item.nm; mid = item.id ; kid = order.vid ; bdata = item.bdata; exBatches = item.bts; allocq = item.q"
                                     ng-include="'views/partial.html'"></div>
                            </td>
                        </tr>
                        </tbody>
                        <tbody>
                        <tr ng-show="edit.mat" ng-controller="orders.MaterialController">
                            <td colspan="3">
                                <div class="form-group has-feedback"><input type="text"
                                       typeahead-template-url="views/materials/materialTemplate.html"
                                       ng-model="mModel"
                                       class="form-control"
                                       placeholder="Type to Add Material"
                                       uib-typeahead="item as item.mnm for item in getFilteredInvntry($viewValue) |  limitTo:8"
                                       typeahead-editable="false"
                                       typeahead-loading="loadingMat"
                                       class="form-control" maxlength="50"/>
                                <span ng-show="loadingMat" class="form-control-feedback typehead-loading" aria-hidden="true"> <span class="glyphicons glyphicons-cogwheel spin"></span> </span>
                                </div>
                            </td>
                            <td colspan="100%"></td>
                        </tr>
                        <tr ng-hide="edit.mat">
                            <td colspan={{showCurStk?5:4}}></td>
                            <td ng-hide="oCfg.dop" class="text-right"><b>{{order.cur}} {{order.price | number : 2}}</b><br><span class="litetext" ng-show="order.tax > 0">(incl. {{order.tax|number : 2}}% tax)</span></td>
                        </tr>
                        </tbody>
                    </table>
                    <div ng-show="edit.mat" class="form-horizontal">
                        <div class="form-group inline">
                            <label for="msg" class="col-sm-2 control-label">{{resourceBundle['message']}}</label>
                            <div class="col-sm-8">
                                <textarea class="form-control" rows="3" ng-model="msg" id="msg" placeholder="160 Characters allowed"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div ng-show="edit.mat" class="col-sm-12">
                    <div class="pull-right">
                        <button class="btn btn-sm btn-primary"
                                ng-click="saveMaterials()" ng-disabled="invalidPopup != 0 || saveDisable">
                            {{resourceBundle['save']}}
                        </button>
                        <button class="btn btn-sm btn-default"
                                ng-click="cancelEditMats()">
                            {{resourceBundle['cancel']}}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>